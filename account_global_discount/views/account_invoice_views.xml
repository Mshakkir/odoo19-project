<?xml version="1.0" encoding="utf-8"?>

<!-- Copyright 2019 Tecnativa - David Vidal
     Copyright 2025 - Odoo 19 CE Conversion
     License AGPL-3.0 or later (https://www.gnu.org/licenses/agpl). -->
<odoo>
    <record id="view_move_form" model="ir.ui.view">
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <!-- Add global discount field after payment terms -->
            <xpath expr="//field[@name='invoice_payment_term_id']/.." position="after">
                <field
                    name="global_discount_ids"
                    widget="many2many_tags"
                    placeholder="Discounts..."
                    readonly="state != 'draft'"
                    groups="base_global_discount.group_global_discount"
                />
                <field
                    string="Invoice Global Discounts"
                    name="global_discount_ids_readonly"
                    widget="many2many_tags"
                    readonly="1"
                    groups="!base_global_discount.group_global_discount"
                />
            </xpath>

            <!-- Add discount amounts before tax totals -->
            <field name="tax_totals" position="before">
                <field
                    name="amount_untaxed_before_global_discounts"
                    string="Untaxed Amount Before Disc."
                    invisible="not global_discount_ids or not invoice_global_discount_ids"
                    groups="base_global_discount.group_global_discount"
                />
                <field
                    name="amount_untaxed_before_global_discounts"
                    string="Untaxed Amount Before Disc."
                    invisible="not global_discount_ids_readonly or not invoice_global_discount_ids"
                    groups="!base_global_discount.group_global_discount"
                />
                <field
                    name="amount_global_discount"
                    string="Global Discounts"
                    invisible="not global_discount_ids or not invoice_global_discount_ids"
                    groups="base_global_discount.group_global_discount"
                />
                <field
                    name="amount_global_discount"
                    string="Global Discounts"
                    invisible="not global_discount_ids_readonly or not invoice_global_discount_ids"
                    groups="!base_global_discount.group_global_discount"
                />
            </field>

            <!-- Add separator styling -->
            <field name="tax_totals" position="attributes">
                <attribute name="class" add="oe_subtotal_footer_separator" separator=" "/>
            </field>

            <!-- Add global discounts detail tab - FIXED XPATH -->
            <!-- Try using name instead of id, or find the correct page identifier -->
            <xpath expr="//page[@name='other_info']" position="inside">
                <separator string="Global Discounts"/>

                <!-- For users with global discount group -->
                <field
                    name="invoice_global_discount_ids"
                    nolabel="1"
                    readonly="1"
                    invisible="not global_discount_ids"
                    force_save="1"
                    groups="base_global_discount.group_global_discount"
                >
                    <list create="0" delete="0">
                        <field name="name"/>
                        <field
                            name="base"
                            widget="monetary"
                            options="{'currency_field': 'currency_id'}"
                        />
                        <field name="discount_display"/>
                        <field name="discount_amount"/>
                        <field
                            name="base_discounted"
                            widget="monetary"
                            options="{'currency_field': 'currency_id'}"
                        />
                        <field name="account_id"/>
                        <field name="tax_ids" widget="many2many_tags"/>
                        <field
                            domain="[('company_id', '=', company_id)]"
                            name="account_analytic_id"
                            groups="analytic.group_analytic_accounting"
                        />
                    </list>
                </field>

                <!-- For users without global discount group -->
                <field
                    name="invoice_global_discount_ids"
                    nolabel="1"
                    readonly="1"
                    invisible="not global_discount_ids_readonly"
                    force_save="1"
                    groups="!base_global_discount.group_global_discount"
                >
                    <list create="0" delete="0">
                        <field name="name"/>
                        <field
                            name="base"
                            widget="monetary"
                            options="{'currency_field': 'currency_id'}"
                        />
                        <field name="discount_display"/>
                        <field name="discount_amount"/>
                        <field
                            name="base_discounted"
                            widget="monetary"
                            options="{'currency_field': 'currency_id'}"
                        />
                        <field name="account_id"/>
                        <field name="tax_ids" widget="many2many_tags"/>
                        <field
                            domain="[('company_id', '=', company_id)]"
                            name="account_analytic_id"
                            groups="analytic.group_analytic_accounting"
                        />
                    </list>
                </field>
            </xpath>
        </field>
    </record>
</odoo>
<!--&lt;!&ndash; Copyright 2019 Tecnativa - David Vidal-->
<!--     Copyright 2025 - Odoo 19 CE Conversion-->
<!--     License AGPL-3.0 or later (https://www.gnu.org/licenses/agpl). &ndash;&gt;-->
<!--<odoo>-->
<!--    <record id="view_move_form" model="ir.ui.view">-->
<!--        <field name="model">account.move</field>-->
<!--        <field name="inherit_id" ref="account.view_move_form"/>-->
<!--        <field name="arch" type="xml">-->
<!--            &lt;!&ndash; Add global discount field after payment terms &ndash;&gt;-->
<!--            <xpath expr="//field[@name='invoice_payment_term_id']/.." position="after">-->
<!--                <field-->
<!--                    name="global_discount_ids"-->
<!--                    widget="many2many_tags"-->
<!--                    placeholder="Discounts..."-->
<!--                    readonly="state != 'draft'"-->
<!--                    groups="base_global_discount.group_global_discount"-->
<!--                />-->
<!--                <field-->
<!--                    string="Invoice Global Discounts"-->
<!--                    name="global_discount_ids_readonly"-->
<!--                    widget="many2many_tags"-->
<!--                    readonly="1"-->
<!--                    groups="!base_global_discount.group_global_discount"-->
<!--                />-->
<!--            </xpath>-->

<!--            &lt;!&ndash; Add discount amounts before tax totals &ndash;&gt;-->
<!--            <field name="tax_totals" position="before">-->
<!--                <field-->
<!--                    name="amount_untaxed_before_global_discounts"-->
<!--                    string="Untaxed Amount Before Disc."-->
<!--                    invisible="not global_discount_ids or not invoice_global_discount_ids"-->
<!--                    groups="base_global_discount.group_global_discount"-->
<!--                />-->
<!--                <field-->
<!--                    name="amount_untaxed_before_global_discounts"-->
<!--                    string="Untaxed Amount Before Disc."-->
<!--                    invisible="not global_discount_ids_readonly or not invoice_global_discount_ids"-->
<!--                    groups="!base_global_discount.group_global_discount"-->
<!--                />-->
<!--                <field-->
<!--                    name="amount_global_discount"-->
<!--                    string="Global Discounts"-->
<!--                    invisible="not global_discount_ids or not invoice_global_discount_ids"-->
<!--                    groups="base_global_discount.group_global_discount"-->
<!--                />-->
<!--                <field-->
<!--                    name="amount_global_discount"-->
<!--                    string="Global Discounts"-->
<!--                    invisible="not global_discount_ids_readonly or not invoice_global_discount_ids"-->
<!--                    groups="!base_global_discount.group_global_discount"-->
<!--                />-->
<!--            </field>-->

<!--            &lt;!&ndash; Add separator styling &ndash;&gt;-->
<!--            <field name="tax_totals" position="attributes">-->
<!--                <attribute name="class" add="oe_subtotal_footer_separator" separator=" "/>-->
<!--            </field>-->

<!--            &lt;!&ndash; Add global discounts detail tab &ndash;&gt;-->
<!--            <xpath expr="//page[@id='other_info']" position="inside">-->
<!--                <separator string="Global Discounts"/>-->

<!--                &lt;!&ndash; For users with global discount group &ndash;&gt;-->
<!--                <field-->
<!--                    name="invoice_global_discount_ids"-->
<!--                    nolabel="1"-->
<!--                    readonly="1"-->
<!--                    invisible="not global_discount_ids"-->
<!--                    force_save="1"-->
<!--                    groups="base_global_discount.group_global_discount"-->
<!--                >-->
<!--                    <list create="0" delete="0">-->
<!--                        <field name="name"/>-->
<!--                        <field-->
<!--                            name="base"-->
<!--                            widget="monetary"-->
<!--                            options="{'currency_field': 'currency_id'}"-->
<!--                        />-->
<!--                        <field name="discount_display"/>-->
<!--                        <field name="discount_amount"/>-->
<!--                        <field-->
<!--                            name="base_discounted"-->
<!--                            widget="monetary"-->
<!--                            options="{'currency_field': 'currency_id'}"-->
<!--                        />-->
<!--                        <field name="account_id"/>-->
<!--                        <field name="tax_ids" widget="many2many_tags"/>-->
<!--                        <field-->
<!--                            domain="[('company_id', '=', company_id)]"-->
<!--                            name="account_analytic_id"-->
<!--                            groups="analytic.group_analytic_accounting"-->
<!--                        />-->
<!--                    </list>-->
<!--                </field>-->

<!--                &lt;!&ndash; For users without global discount group &ndash;&gt;-->
<!--                <field-->
<!--                    name="invoice_global_discount_ids"-->
<!--                    nolabel="1"-->
<!--                    readonly="1"-->
<!--                    invisible="not global_discount_ids_readonly"-->
<!--                    force_save="1"-->
<!--                    groups="!base_global_discount.group_global_discount"-->
<!--                >-->
<!--                    <list create="0" delete="0">-->
<!--                        <field name="name"/>-->
<!--                        <field-->
<!--                            name="base"-->
<!--                            widget="monetary"-->
<!--                            options="{'currency_field': 'currency_id'}"-->
<!--                        />-->
<!--                        <field name="discount_display"/>-->
<!--                        <field name="discount_amount"/>-->
<!--                        <field-->
<!--                            name="base_discounted"-->
<!--                            widget="monetary"-->
<!--                            options="{'currency_field': 'currency_id'}"-->
<!--                        />-->
<!--                        <field name="account_id"/>-->
<!--                        <field name="tax_ids" widget="many2many_tags"/>-->
<!--                        <field-->
<!--                            domain="[('company_id', '=', company_id)]"-->
<!--                            name="account_analytic_id"-->
<!--                            groups="analytic.group_analytic_accounting"-->
<!--                        />-->
<!--                    </list>-->
<!--                </field>-->
<!--            </xpath>-->
<!--        </field>-->
<!--    </record>-->
<!--</odoo>-->