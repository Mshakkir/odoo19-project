<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit and modify the sale order portal content template -->
    <template id="custom_sale_order_portal_content"
              name="Custom Sale Order Portal Content"
              inherit_id="sale.sale_order_portal_content"
              priority="99">

        <!-- Add custom styles -->
        <xpath expr="//div[@id='portal_sale_content']" position="before">
            <style>
                .breadcrumb { display: none !important; }
                .o_portal_sidebar { display: none !important; }
                #portal_sale_content { max-width: 1200px; margin: 20px auto; padding: 20px; background: white; }
            </style>
        </xpath>

        <!-- Replace the main header card -->
        <xpath expr="//div[@id='portal_sale_content']/div[@class='card mt-3']" position="replace">
            <!-- CUSTOM HEADER -->
            <div class="card mt-3" style="border: none;">
                <div class="card-body p-0">
                    <t t-set="o" t-value="sale_order"/>

                    <table style="width: 100%; margin-bottom: 15px;">
                        <tr>
                            <td style="width: 33%; color: #8B1538; font-size: 16px; font-weight: bold;">
                                SAMEER SHARAF AL OTAIBI TRADING COMPANY
                            </td>
                            <td style="width: 34%; text-align: center;">
                                <img t-if="o.company_id.logo" t-att-src="image_data_uri(o.company_id.logo)" style="max-height: 80px;"/>
                            </td>
                            <td style="width: 33%; text-align: right; color: #8B1538; font-size: 17px; direction: rtl;">
                                شركة سمير شرف العتيبي التجارية
                            </td>
                        </tr>
                        <tr>
                            <td style="border-top: 2px solid #8B1538; padding-top: 10px;">
                                C.R. 4030216154<br/>VAT: 311299944700003
                            </td>
                            <td style="border-top: 2px solid #8B1538;"></td>
                            <td style="border-top: 2px solid #8B1538; text-align: right; padding-top: 10px; direction: rtl;">
                                س.ت: ٤٠٣٠٢١٦١٥٤<br/>الرقم الضريبي: ٣١١٢٩٩٩٤٤٧٠٠٠٠٣
                            </td>
                        </tr>
                    </table>

                    <!-- TITLE -->
                    <div style="background: #d3d3d3; padding: 10px; text-align: center; font-weight: bold; margin: 15px 0;">
                        <t t-if="o.state in ('draft', 'sent')">Quotation / عرض سعر</t>
                        <t t-else="">Sales Order / طلب مبيعات</t>
                    </div>

                    <!-- CUSTOMER INFO -->
                    <table width="100%" style="border: 1px solid #000; border-collapse: collapse; margin: 10px 0;">
                        <tr>
                            <td width="50%" style="border-right: 1px solid #000; padding: 10px;">
                                <strong>Customer / العميل</strong><br/>
                                <span t-esc="o.partner_id.name"/><br/>
                                <span t-esc="o.partner_id.city"/><br/>
                                <span t-esc="o.partner_id.phone or ''"/>
                            </td>
                            <td width="50%" style="padding: 10px;">
                                <strong>Order Details / تفاصيل الطلب</strong><br/>
                                Date: <span t-field="o.date_order"/><br/>
                                Ref: <span t-esc="o.name"/><br/>
                                Your Ref: <span t-esc="o.client_order_ref or '-'"/>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </xpath>

        <!-- Replace the order lines table -->
        <xpath expr="//table[@id='sales_order_table']" position="replace">
            <table id="sales_order_table" class="table table-sm" width="100%" border="1" style="border-collapse: collapse; margin: 15px 0;">
                <thead style="background: #9e9d9d;">
                    <tr>
                        <th style="padding: 8px; text-align: center;">SN</th>
                        <th style="padding: 8px;">Item Description</th>
                        <th style="padding: 8px; text-align: center;">QTY</th>
                        <th style="padding: 8px; text-align: center;">Unit Price</th>
                        <th style="padding: 8px; text-align: center;">VAT%</th>
                        <th style="padding: 8px; text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <t t-set="current_subtotal" t-value="0"/>
                    <t t-foreach="sale_order.order_line" t-as="line">
                        <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal"/>
                        <tr t-att-data-line-id="line.id">
                            <td style="padding: 8px; text-align: center;">
                                <t t-esc="line_index + 1"/>
                            </td>
                            <td style="padding: 8px;" id="product_name">
                                <span t-field="line.name"/>
                            </td>
                            <td style="padding: 8px; text-align: center;">
                                <span t-esc="line.product_uom_qty"/>
                                <span t-esc="line.product_uom_id.name"/>
                            </td>
                            <td style="padding: 8px; text-align: right;">
                                <span t-field="line.price_unit"/> SAR
                            </td>
                            <td style="padding: 8px; text-align: center;">
                                <t t-if="line.tax_ids">
                                    <t t-esc="line.tax_ids[0].amount"/>%
                                </t>
                                <t t-else="">0%</t>
                            </td>
                            <td style="padding: 8px; text-align: right;">
                                <span t-field="line.price_total"/> SAR
                            </td>
                        </tr>
                    </t>
                </tbody>
            </table>
        </xpath>

        <!-- Replace the totals section -->
        <xpath expr="//div[@id='total']" position="replace">
            <div id="total" class="row" style="width: 100%;">
                <div class="col-12">
                    <table style="width: 40%; margin-left: auto; border: 1px solid #000; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 8px;">Subtotal</td>
                            <td style="padding: 8px; text-align: right;">
                                <span t-field="sale_order.amount_untaxed"
                                      t-options="{'widget': 'monetary', 'display_currency': sale_order.currency_id}"/> SAR
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;">VAT (15%)</td>
                            <td style="padding: 8px; text-align: right;">
                                <span t-field="sale_order.amount_tax"
                                      t-options="{'widget': 'monetary', 'display_currency': sale_order.currency_id}"/> SAR
                            </td>
                        </tr>
                        <tr style="background: #d3d3d3; font-weight: bold;">
                            <td style="padding: 8px;">Net Total</td>
                            <td style="padding: 8px; text-align: right;">
                                <span t-field="sale_order.amount_total"
                                      t-options="{'widget': 'monetary', 'display_currency': sale_order.currency_id}"/> SAR
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </xpath>

        <!-- Add terms section at the end -->
        <xpath expr="//div[@id='portal_sale_content']" position="inside">
            <div class="mt-4">
                <p><strong>Terms and Conditions:</strong></p>
                <p t-if="sale_order.payment_term_id">
                    Payment Terms: <span t-esc="sale_order.payment_term_id.name"/>
                </p>
                <p t-if="sale_order.incoterm_id">
                    Incoterm: <span t-esc="sale_order.incoterm_id.name"/>
                </p>
                <p t-if="sale_order.note" t-field="sale_order.note"/>
            </div>
        </xpath>
    </template>
</odoo>