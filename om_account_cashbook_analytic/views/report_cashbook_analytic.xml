<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Report Action -->
    <report
        id="action_report_cash_book_analytic"
        model="account.cashbook.report"
        string="Cash Book with Analytic"
        report_type="qweb-pdf"
        name="account_cashbook_analytic.report_cashbook_analytic"
        file="account_cashbook_analytic.report_cashbook_analytic"
        print_report_name="'Cash Book - %s' % (object.date_from)"
    />

    <!-- Report Template -->
    <template id="report_cashbook_analytic">
        <t t-call="web.html_container">
            <t t-set="data_report_margin_top" t-value="12"/>
            <t t-set="data_report_header_spacing" t-value="9"/>
            <t t-set="data_report_dpi" t-value="110"/>
            <t t-call="web.internal_layout">

                <!-- ======= PAGE HEADER ======= -->
                <div class="page">
                    <h2>
                        Cash Book Report
                        <span t-if="group_by_analytic and report_type == 'combined'">
                            - Grouped by Analytic Account
                        </span>
                        <span t-if="analytic_account_names">
                            (<t t-esc="', '.join(analytic_account_names)"/>)
                        </span>
                    </h2>
                </div>

                <!-- ======= FILTER INFO ======= -->
                <div class="row mt32">
                    <div class="col-4">
                        <strong>Journals:</strong>
                        <p t-esc="', '.join([lt or '' for lt in print_journal])"/>
                    </div>
                    <div class="col-2">
                        <strong>Start Date:</strong>
                        <p t-esc="data.get('date_from')"/>
                    </div>
                    <div class="col-2">
                        <strong>End Date:</strong>
                        <p t-esc="data.get('date_to')"/>
                    </div>
                    <div class="col-2">
                        <strong>Sorted By:</strong>
                        <p t-if="data.get('sortby') == 'sort_date'">Date</p>
                        <p t-if="data.get('sortby') == 'sort_journal_partner'">Journal and Partner</p>
                    </div>
                    <div class="col-2">
                        <strong>Target Moves:</strong>
                        <p t-if="data.get('target_move') == 'all'">All Entries</p>
                        <p t-if="data.get('target_move') == 'posted'">Posted Entries</p>
                    </div>
                </div>

                <div class="row mt16" t-if="analytic_account_names">
                    <div class="col-12">
                        <strong>Filtered by Analytic Accounts:</strong>
                        <p t-esc="', '.join(analytic_account_names)"/>
                    </div>
                </div>

                <br/>

                <!-- ======= ANALYTIC GROUPED REPORT ======= -->
                <t t-if="group_by_analytic and report_type == 'combined' and analytic_grouped_data">
                    <t t-foreach="analytic_grouped_data" t-as="analytic_group">
                        <div class="mt32">
                            <h4 style="background-color:#f0f0f0;padding:10px;margin-bottom:10px;">
                                <strong>Analytic Account:</strong>
                                <span t-esc="analytic_group['analytic_name']"/>
                            </h4>

                            <table class="table table-sm table-reports">
                                <thead>
                                    <tr class="text-center">
                                        <th>Date</th>
                                        <th>JRNL</th>
                                        <th>Partner</th>
                                        <th>Ref</th>
                                        <th>Move</th>
                                        <th>Entry Label</th>
                                        <th>Debit</th>
                                        <th>Credit</th>
                                        <th>Balance</th>
                                        <th groups="base.group_multi_currency">Currency</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="analytic_group['accounts']" t-as="account">
                                        <tr style="font-weight:bold;">
                                            <td colspan="6">
                                                <span t-esc="account['code']"/> -
                                                <span t-esc="account['name']"/>
                                            </td>
                                            <td class="text-end">
                                                <span t-esc="account['debit']"
                                                    t-options="{'widget':'monetary','display_currency':env.company.currency_id}"/>
                                            </td>
                                            <td class="text-end">
                                                <span t-esc="account['credit']"
                                                    t-options="{'widget':'monetary','display_currency':env.company.currency_id}"/>
                                            </td>
                                            <td class="text-end">
                                                <span t-esc="account['balance']"
                                                    t-options="{'widget':'monetary','display_currency':env.company.currency_id}"/>
                                            </td>
                                            <td groups="base.group_multi_currency"/>
                                        </tr>

                                        <tr t-foreach="account['move_lines']" t-as="line">
                                            <td><span t-esc="line['ldate']"/></td>
                                            <td><span t-esc="line['lcode']"/></td>
                                            <td><span t-esc="line['partner_name']"/></td>
                                            <td><span t-if="line['lref']" t-esc="line['lref']"/></td>
                                            <td><span t-esc="line['move_name']"/></td>
                                            <td><span t-esc="line['lname']"/></td>
                                            <td class="text-end">
                                                <span t-esc="line['debit']"
                                                    t-options="{'widget':'monetary','display_currency':env.company.currency_id}"/>
                                            </td>
                                            <td class="text-end">
                                                <span t-esc="line['credit']"
                                                    t-options="{'widget':'monetary','display_currency':env.company.currency_id}"/>
                                            </td>
                                            <td class="text-end">
                                                <span t-esc="line['balance']"
                                                    t-options="{'widget':'monetary','display_currency':env.company.currency_id}"/>
                                            </td>
                                            <td t-if="line['amount_currency']" class="text-end"
                                                groups="base.group_multi_currency">
                                                <span t-esc="line['amount_currency']"/>
                                                <span t-esc="line['currency_code']"/>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                        <t t-if="not loop.last">
                            <div style="page-break-after:always;"/>
                        </t>
                    </t>
                </t>

                <!-- ======= STANDARD REPORT ======= -->
                <t t-if="not group_by_analytic or report_type == 'separate'">
                    <table class="table table-sm table-reports">
                        <thead>
                            <tr class="text-center">
                                <th>Date</th>
                                <th>JRNL</th>
                                <th>Partner</th>
                                <th>Ref</th>
                                <th>Move</th>
                                <th>Entry Label</th>
                                <th>Analytic Account</th>
                                <th>Debit</th>
                                <th>Credit</th>
                                <th>Balance</th>
                                <th groups="base.group_multi_currency">Currency</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="Accounts" t-as="account">
                                <tr style="font-weight:bold;">
                                    <td colspan="7">
                                        <span t-esc="account['code']"/> -
                                        <span t-esc="account['name']"/>
                                    </td>
                                    <td class="text-end">
                                        <span t-esc="account['debit']"
                                            t-options="{'widget':'monetary','display_currency':env.company.currency_id}"/>
                                    </td>
                                    <td class="text-end">
                                        <span t-esc="account['credit']"
                                            t-options="{'widget':'monetary','display_currency':env.company.currency_id}"/>
                                    </td>
                                    <td class="text-end">
                                        <span t-esc="account['balance']"
                                            t-options="{'widget':'monetary','display_currency':env.company.currency_id}"/>
                                    </td>
                                    <td groups="base.group_multi_currency"/>
                                </tr>

                                <tr t-foreach="account['move_lines']" t-as="line">
                                    <td><span t-esc="line['ldate']"/></td>
                                    <td><span t-esc="line['lcode']"/></td>
                                    <td><span t-esc="line['partner_name']"/></td>
                                    <td><span t-if="line['lref']" t-esc="line['lref']"/></td>
                                    <td><span t-esc="line['move_name']"/></td>
                                    <td><span t-esc="line['lname']"/></td>
                                    <td><span t-esc="line.get('analytic_account_name', '')"/></td>
                                    <td class="text-end">
                                        <span t-esc="line['debit']"
                                            t-options="{'widget':'monetary','display_currency':env.company.currency_id}"/>
                                    </td>
                                    <td class="text-end">
                                        <span t-esc="line['credit']"
                                            t-options="{'widget':'monetary','display_currency':env.company.currency_id}"/>
                                    </td>
                                    <td class="text-end">
                                        <span t-esc="line['balance']"
                                            t-options="{'widget':'monetary','display_currency':env.company.currency_id}"/>
                                    </td>
                                    <td t-if="line['amount_currency']" class="text-end"
                                        groups="base.group_multi_currency">
                                        <span t-esc="line['amount_currency']"/>
                                        <span t-esc="line['currency_code']"/>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </t>
            </t>
        </t>
    </template>
</odoo>
